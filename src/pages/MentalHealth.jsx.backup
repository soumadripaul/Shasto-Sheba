import React, { useState, useEffect } from 'react';
import ApiService from '../services/api';
import '../styles/MentalHealth.css';

const MentalHealth = () => {
  const [selectedMood, setSelectedMood] = useState(null);
  const [moodHistory, setMoodHistory] = useState([]);
  const [showMessage, setShowMessage] = useState(false);
  const [messageText, setMessageText] = useState('');
  const [userId, setUserId] = useState('');
  const [notes, setNotes] = useState('');
  const [showNoteInput, setShowNoteInput] = useState(false);
  const [viewMode, setViewMode] = useState('week'); // week or month

  const moods = [
    { emoji: 'ЁЯШК', label: 'ржЦрзБржм ржнрж╛рж▓рзЛ', value: 10, numValue: 10, color: '#22c55e' },
    { emoji: 'ЁЯЩВ', label: 'ржнрж╛рж▓рзЛ', value: 8, numValue: 8, color: '#84cc16' },
    { emoji: 'ЁЯШР', label: 'ржорзЛржЯрж╛ржорзБржЯрж┐', value: 6, numValue: 6, color: '#fbbf24' },
    { emoji: 'я┐╜', label: 'ржПржХржЯрзБ ржЦрж╛рж░рж╛ржк', value: 4, numValue: 4, color: '#fb923c' },
    { emoji: 'ЁЯШЮ', label: 'ржЦрж╛рж░рж╛ржк', value: 2, numValue: 2, color: '#f87171' }
  ];

  useEffect(() => {
    // Load mood history from localStorage
    const savedMoods = localStorage.getItem('moodHistory');
    if (savedMoods) {
      setMoodHistory(JSON.parse(savedMoods));
    }
  }, []);

  const handleMoodSelect = (mood) => {
    const today = new Date().toISOString().split('T')[0];
    const newEntry = {
      date: today,
      mood: mood.value,
      emoji: mood.emoji,
      color: mood.color,
      timestamp: new Date().toISOString()
    };

    // Check if already logged today
    const existingIndex = moodHistory.findIndex(entry => entry.date === today);
    let updatedHistory;
    
    if (existingIndex >= 0) {
      updatedHistory = [...moodHistory];
      updatedHistory[existingIndex] = newEntry;
    } else {
      updatedHistory = [newEntry, ...moodHistory].slice(0, 30); // Keep last 30 days
    }

    setMoodHistory(updatedHistory);
    localStorage.setItem('moodHistory', JSON.stringify(updatedHistory));
    setSelectedMood(mood);
    setShowMessage(true);

    // Send anonymous aggregated data (Mission 9)
    sendAnonymousData(mood.value);

    setTimeout(() => setShowMessage(false), 3000);
  };

  const sendAnonymousData = (moodValue) => {
    // This would send anonymous data to server when online
    if (navigator.onLine) {
      // Example: fetch('/api/mood-checkin', { method: 'POST', body: JSON.stringify({ event: 'mood_checkin', upazila: 'unknown' }) })
      console.log('Anonymous mood data sent:', { event: 'mood_checkin', mood: moodValue });
    }
  };

  const getLastSevenDays = () => {
    const days = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const dayName = date.toLocaleDateString('bn-BD', { weekday: 'short' });
      const mood = moodHistory.find(entry => entry.date === dateStr);
      days.push({ date: dateStr, dayName, mood });
    }
    return days;
  };

  return (
    <div className="mental-health-container">
      <div className="mental-health-content">
        <h1 className="page-title">
          <span className="title-icon">ЁЯТн</span>
          ржЖржЬ ржЖржкржирж╛рж░ ржоржи ржХрзЗржоржи?
        </h1>
        <p className="page-subtitle">
          ржЖржкржирж╛рж░ ржорж╛ржирж╕рж┐ржХ ржЕржмрж╕рзНржерж╛ ржЬрж╛ржирж╛ржиред ржПржЯрж┐ рж╕ржорзНржкрзВрж░рзНржг ржЧрзЛржкржирзАржпрж╝ ржПржмржВ рж╢рзБржзрзБржорж╛рждрзНрж░ ржЖржкржирж╛рж░ ржлрзЛржирзЗ рж╕ржВрж░ржХрзНрж╖рж┐ржд ржерж╛ржХржмрзЗред
        </p>

        <div className="mood-selector">
          {moods.map((mood, index) => (
            <button
              key={index}
              className={`mood-button ${selectedMood?.value === mood.value ? 'selected' : ''}`}
              onClick={() => handleMoodSelect(mood)}
              style={{ '--mood-color': mood.color }}
            >
              <span className="mood-emoji">{mood.emoji}</span>
              <span className="mood-label">{mood.label}</span>
            </button>
          ))}
        </div>

        {showMessage && (
          <div className="success-message">
            тЬУ ржЖржкржирж╛рж░ ржорзБржб рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
          </div>
        )}

        {moodHistory.length > 0 && (
          <div className="mood-history">
            <h2>ржЧржд рзн ржжрж┐ржирзЗрж░ рж░рзЗржХрж░рзНржб</h2>
            <div className="calendar-view">
              {getLastSevenDays().map((day, index) => (
                <div key={index} className="calendar-day">
                  <div className="day-name">{day.dayName}</div>
                  <div 
                    className="day-mood"
                    style={{ 
                      backgroundColor: day.mood ? day.mood.color : '#e5e7eb',
                      color: day.mood ? 'white' : '#9ca3af'
                    }}
                  >
                    {day.mood ? day.mood.emoji : 'тАФ'}
                  </div>
                </div>
              ))}
            </div>

            <div className="mood-insights">
              <h3>ржЖржкржирж╛рж░ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи</h3>
              <div className="insights-grid">
                <div className="insight-card">
                  <span className="insight-icon">ЁЯУК</span>
                  <span className="insight-value">{moodHistory.length}</span>
                  <span className="insight-label">ржорзЛржЯ рж░рзЗржХрж░рзНржб</span>
                </div>
                <div className="insight-card">
                  <span className="insight-icon">ЁЯШК</span>
                  <span className="insight-value">
                    {moodHistory.filter(m => m.mood === 'good').length}
                  </span>
                  <span className="insight-label">ржнрж╛рж▓рзЛ ржжрж┐ржи</span>
                </div>
                <div className="insight-card">
                  <span className="insight-icon">ЁЯШР</span>
                  <span className="insight-value">
                    {moodHistory.filter(m => m.mood === 'okay').length}
                  </span>
                  <span className="insight-label">ржорзЛржЯрж╛ржорзБржЯрж┐ ржжрж┐ржи</span>
                </div>
                <div className="insight-card">
                  <span className="insight-icon">ЁЯШЮ</span>
                  <span className="insight-value">
                    {moodHistory.filter(m => m.mood === 'bad').length}
                  </span>
                  <span className="insight-label">ржЦрж╛рж░рж╛ржк ржжрж┐ржи</span>
                </div>
              </div>
            </div>
          </div>
        )}

        <div className="privacy-notice">
          <span className="privacy-icon">ЁЯФТ</span>
          <p>ржЖржкржирж╛рж░ рж╕ржХрж▓ рждржерзНржп рж╢рзБржзрзБржорж╛рждрзНрж░ ржЖржкржирж╛рж░ ржлрзЛржирзЗ рж╕ржВрж░ржХрзНрж╖рж┐рждред ржХрзЛржирзЛ рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝ ржирж╛ред</p>
        </div>
      </div>
    </div>
  );
};

export default MentalHealth;
